{% extends "layout.html" %}

{% block content_header %}
  {{ build_breadcrumb('Users', '', 'user', ['List']) }}
{% endblock %}

{% block content %}
    {% set name = resource.firstname ~ (' ' ~ resource.lastname if resource.lastname else '') %}
    {% call build_section_row() %}
      {% call build_form_tabs_box() %}
        {% call build_tabs_navigation() %}
          {{ add_tab_navigation_header('User', name, 'user') }}
          {{ add_tab_navigation_item('user', 'User', active=True) }}
          {{ add_tab_navigation_item('general', 'General') }}
          {{ add_tab_navigation_item('fallbacks', 'Fallbacks') }}
          {{ add_tab_navigation_item('services', 'Services') }}
          {{ add_tab_navigation_item('lines', 'Lines') }}
        {% endcall %}
        {% call build_form(action=url_for('.UserView:put', id=resource.uuid)) %}
          {% call build_tabs_content() %}

            {% call build_tab_content_item('user', active=True) %}
              {% call add_default_fields(form=form, submit_value="Update") %}
                {{ render_field(form.firstname) }}
                {{ render_field(form.lastname) }}
                {{ render_field(form.email) }}
                {{ render_field(form.username) }}
                {{ render_field(form.password) }}
              {% endcall %}
            {% endcall %}

            {% call build_tab_content_item('general') %}
              {% call add_default_fields(form=form, submit_value="Update") %}
                {{ render_field(form.mobile_phone_number) }}
                {{ render_field(form.ring_seconds) }}
                {{ render_field(form.music_on_hold, data_listing_href=url_for(listing_urls['moh'])) }}
                {{ render_field(form.preprocess_subroutine) }}
                {{ render_field(form.simultaneous_calls) }}
                {{ render_field(form.timezone) }}
                {{ render_field(form.userfield) }}
                {{ render_field(form.description) }}
              {% endcall %}
            {% endcall %}

            {% call build_tab_content_item('fallbacks') %}
              {% call add_default_fields(form=form, submit_value="Update") %}
                {{ render_field(form.fallbacks.busy_destination) }}
                {{ render_field(form.fallbacks.congestion_destination) }}
                {{ render_field(form.fallbacks.fail_destination) }}
                {{ render_field(form.fallbacks.noanswer_destination) }}
              {% endcall %}
            {% endcall %}

            {% call build_tab_content_item('services') %}
              {% call add_default_fields(form=form, submit_value="Update") %}
                {{ render_field(form.services.dnd) }}
                {{ render_field(form.services.incallfilter) }}
                {{ render_field(form.forwards.busy) }}
                {{ render_field(form.forwards.unconditional) }}
                {{ render_field(form.forwards.noanswer) }}
              {% endcall %}
            {% endcall %}

            {% call build_tab_content_item('lines') %}
              {{ build_add_row_entry_header() }}
              {% call add_default_fields(form=form, submit_value="Update") %}
                {% call build_table() %}

                  {% call build_table_headers() %}
                    <th>Protocol</th>
                    <th>Name</th>
                    <th>Context</th>
                    <th>Extension</th>
                    <th>Device</th>
                    <th>Line (N°)</th>
                  {% endcall %}

                  {% call build_table_body(class_='dynamic-table') %}
                    {% do form.lines.append_entry() %}
                    {{ _build_line_entry(form.lines.pop_entry(), template=True) }}

                    {% for line in form.lines %}
                      {{ _build_line_entry(line) }}
                    {% endfor %}
                  {% endcall %}

                {% endcall %}
              {% endcall %}
            {% endcall %}

          {% endcall %}
        {% endcall %}
      {% endcall %}
    {% endcall %}
{% endblock %}


{% macro _build_line_entry(line, template=False) %}
  {% if template %}
    {% set tr_class = "row-template hidden" %}
  {% endif %}
  <tr class="{{ tr_class }}">
    {{ render_field(line.line_id) }}
    {{ render_field(line.endpoint_sip_id) }}
    {{ render_field(line.endpoint_sccp_id) }}
    {{ render_field(line.endpoint_custom_id) }}
    {{ render_field(line.extension_id) }}
    <td class="col-sm-2">
      {{ render_field(line.protocol, with_label=False) }}
    </td>
    <td class="col-sm-2">
      {{ render_field(line['name'], with_label=False) }}
    </td>
    <td class="col-sm-2">
      {{ render_field(line.context, with_label=False, data_listing_href=url_for(listing_urls['context_by_type'], type_='internal')) }}
    </td>
    <td class="col-sm-1">
      {{ render_field(line.extension, with_label=False, data_allow_custom_values=True) }}
    </td>
    <td class="col-sm-4">
      {{ render_field(line.device, with_label=False, data_listing_href=url_for(listing_urls['device'])) }}
    </td>
    <td class="col-sm-1">
      {{ render_field(line.position, with_label=False) }}
    </td>
    <td class="col-sm-1">
      {{ add_delete_entry_button() }}
    </td>
  </tr>
{% endmacro %}


{% block additional_js %}
  <script src="{{ url_for('.static', filename='js/user.js') }}"></script>
{% endblock %}
